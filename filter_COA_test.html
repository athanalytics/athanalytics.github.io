<!DOCTYPE html>
<html>
<head>
  <title>COA Filter Test</title>
  <link rel="stylesheet" type="text/css" href="asset/master2.css">
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDVNwbw1tkMCu-qSKXyt3MZsvLPXJGBvR8",
      authDomain: "athanalytics-daa90.firebaseapp.com",
      projectId: "athanalytics-daa90",
      storageBucket: "athanalytics-daa90.appspot.com",
      messagingSenderId: "606022473336",
      appId: "1:606022473336:web:db54e91edc7901aa48ff8d",
      measurementId: "G-TP6D394Y1D"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    console.log("Firebase initialized");

    // Test Firestore connection
    async function testFirestoreConnection() {
      try {
        const docRef = doc(db, "testCollection", "testDocument");
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          console.log("Document data:", docSnap.data());
        } else {
          console.log("No such document!");
        }
      } catch (error) {
        console.error("Error getting document:", error);
      }
    }

    // Call the test function on page load
    testFirestoreConnection();

    async function filterData() {
      const ccSearch = document.getElementById('cc-search').value;
      const ydSearch = document.getElementById('yd-search').value;
      const pgSearch = document.getElementById('pg-search').value;
      const pjSearch = document.getElementById('pj-search').value;
      const scSearch = document.getElementById('sc-search').value;
      const spSearch = document.getElementById('sp-search').value;
      const hmSearch = document.getElementById('hm-search').value;

      console.log("Search terms: ", { ccSearch, ydSearch, pgSearch, pjSearch, scSearch, spSearch, hmSearch });

      try {
        let q = query(collection(db, "filter_COA"));

        if (ccSearch) q = query(q, where("Cost.Center", ">=", ccSearch), where("Cost.Center", "<=", ccSearch + "\uf8ff"));
        if (ydSearch) q = query(q, where("YD.Code", ">=", ydSearch), where("YD.Code", "<=", ydSearch + "\uf8ff"));
        if (pgSearch) q = query(q, where("Program", ">=", pgSearch), where("Program", "<=", pgSearch + "\uf8ff"));
        if (pjSearch) q = query(q, where("Project", ">=", pjSearch), where("Project", "<=", pjSearch + "\uf8ff"));
        if (scSearch) q = query(q, where("Spend.Category", ">=", scSearch), where("Spend.Category", "<=", scSearch + "\uf8ff"));
        if (spSearch) q = query(q, where("Supplier", ">=", spSearch), where("Supplier", "<=", spSearch + "\uf8ff"));
        if (hmSearch) q = query(q, where("Memo", ">=", hmSearch), where("Memo", "<=", hmSearch + "\uf8ff"));

        const querySnapshot = await getDocs(q);
        const data = querySnapshot.docs.map(doc => doc.data());
        console.log("Data fetched: ", data);
        renderData(data);
      } catch (error) {
        console.error("Error fetching data: ", error);
      }
    }

    function renderData(data) {
      console.log("Rendering data...");
      const tableBody = document.getElementById('myTableBody');
      tableBody.innerHTML = ''; // Clear previous results
      data.forEach(item => {
        console.log("Rendering item: ", item);
        const row = document.createElement('tr');
        row.innerHTML = `<td>${item['Cost.Center']}</td><td>${item['YD.Code']}</td><td>${item['Program']}</td><td>${item['Project']}</td><td>${item['Spend.Category']}</td><td>${item['Supplier']}</td><td>${item['Memo']}</td>`;
        tableBody.appendChild(row);
      });
      console.log("Data rendered");
    }
  </script>
</head>
<body>
  <h1>Business Office: COA Filter Test</h1>
  
  <!-- Search Input -->
  <input type="text" id="cc-search" onkeyup="filterData()" placeholder="Cost Center.." class="table-search-filters">
  <input type="text" id="yd-search" onkeyup="filterData()" placeholder="YD Code.." class="table-search-filters">
  <input type="text" id="pg-search" onkeyup="filterData()" placeholder="Program.." class="table-search-filters">
  <input type="text" id="pj-search" onkeyup="filterData()" placeholder="Project.." class="table-search-filters">
  <input type="text" id="sc-search" onkeyup="filterData()" placeholder="Spend Category.." class="table-search-filters">
  <input type="text" id="sp-search" onkeyup="filterData()" placeholder="Supplier.." class="table-search-filters">
  <input type="text" id="hm-search" onkeyup="filterData()" placeholder="Memo.." class="table-search-filters">
  
  <!-- Table to Display Results -->
  <table id="myTable">
    <thead>
      <tr class="header">
        <th>Cost Center</th>
        <th>YD Code</th>
        <th>Program</th>
        <th>Project</th>
        <th>Spend Category</th>
        <th>Supplier</th>
        <th>Memo</th>
      </tr>
    </thead>
    <tbody id="myTableBody">
      <!-- Data rows will be inserted here -->
    </tbody>
  </table>
</body>
</html>
